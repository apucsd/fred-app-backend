name: Deploy fred-backend to VPS

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Deploy to VPS
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  command_timeout: 10m
                  script: |
                      # Load NVM
                      export NVM_DIR="$HOME/.nvm"
                      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

                      cd /var/www/iamthatiam/imthatim-backend

                      echo "ðŸ“¦ Pulling latest code..."
                      git pull origin main

                      echo "ðŸ“š Installing dependencies..."
                      yarn install --production

                      echo "ðŸ”§ Generating Prisma Client..."
                      npx prisma generate

                      echo "ðŸ”„ Reloading fred-backend..."
                      pm2 reload fred-backend --update-env || pm2 restart fred-backend

                      echo "âœ… Deployment completed!"
                      pm2 status fred-backend
                      pm2 logs fred-backend --lines 15 --nostream
